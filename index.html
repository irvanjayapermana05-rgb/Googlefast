<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>System Panel</title> <link rel="preconnect" href="https://www.google.com">
    <link rel="preconnect" href="https://inject-fb-default-rtdb.asia-southeast1.firebasedatabase.app" crossorigin>
    <link rel="dns-prefetch" href="https://inject-fb-default-rtdb.asia-southeast1.firebasedatabase.app">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        /* CSS BERSIH */
        body { 
            background-color: white; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            height: 100vh; margin: 0; overflow: hidden; 
        }

        /* Container Tombol */
        .btn-container { 
            display: flex; 
            flex-direction: column; /* Tombol disusun ke bawah agar rapi */
            gap: 15px; 
            width: 80%; 
            max-width: 300px;
        }
        
        button { 
            background-color: #f1f3f4; 
            border: 1px solid #dadce0; 
            border-radius: 8px; 
            color: #3c4043; 
            font-size: 16px; 
            font-weight: 500;
            padding: 15px 20px; 
            cursor: pointer; 
            transition: background 0.2s;
            width: 100%;
        }
        
        button:active { 
            background-color: #e8eaed; 
            transform: scale(0.98); 
        }

        /* Hilangkan highlight biru di mobile */
        button { -webkit-tap-highlight-color: transparent; outline: none; }
    </style>
</head>
<body>

    <div id="main-ui">
        <div class="btn-container">
            <button onclick="siapkan('web')">Web Search</button>
            <button onclick="siapkan('image')">Image Search</button>
            <button onclick="siapkan('wiki')">Wikipedia</button>
        </div>
    </div>

    <script>
        // --- KONFIGURASI DATABASE ---
        const REST_API = "https://inject-fb-default-rtdb.asia-southeast1.firebasedatabase.app/prediksi.json";
        
        // Konfigurasi Firebase SDK
        const firebaseConfig = { databaseURL: "https://inject-fb-default-rtdb.asia-southeast1.firebasedatabase.app/" };
        try { firebase.initializeApp(firebaseConfig); } catch(e){}

        let targetMode = 'web';
        let isWaiting = false;
        let hasRedirected = false;

        // --- FUNGSI PERSIAPAN ---
        function siapkan(mode) {
            targetMode = mode;
            isWaiting = true;
            hasRedirected = false;
            
            // 1. Sembunyikan Tombol (Jadi Layar Putih Polos)
            document.getElementById('main-ui').style.display = 'none';
            
            // 2. Bersihkan Data Lama
            fetch(REST_API, { method: 'PUT', body: JSON.stringify(null) }).catch(()=>{});

            // 3. Mulai Polling Aktif
            mulaiPollingAktif();
        }

        // --- FUNGSI REDIRECT ---
        function eksekusiRedirect(data) {
            if (!data || hasRedirected) return;
            hasRedirected = true; 
            
            let finalUrl = "";
            let enc = encodeURIComponent(data);

            if (data === "autodraw") finalUrl = "https://www.autodraw.com/";
            else if (data.indexOf("calc:") === 0) finalUrl = "https://www.google.com/search?q=" + data.split(":")[1];
            else if (data.indexOf("timer:") === 0) finalUrl = "https://www.google.com/search?q=timer";
            else {
                if (targetMode === 'image') finalUrl = "https://www.google.com/search?tbm=isch&q=" + enc;
                else if (targetMode === 'wiki') finalUrl = "https://id.wikipedia.org/w/index.php?search=" + enc;
                else finalUrl = "https://www.google.com/search?q=" + enc;
            }
            
            window.location.replace(finalUrl);
        }

        // --- TEKNIK 1: FIREBASE LISTENER ---
        try {
            const db = firebase.database().ref('prediksi');
            db.on('value', (snapshot) => {
                if (isWaiting) eksekusiRedirect(snapshot.val());
            });
        } catch(e) {}

        // --- TEKNIK 2: BURST POLLING (Turbo Mode) ---
        async function cekCepat() {
            if(!isWaiting || hasRedirected) return;
            try {
                let res = await fetch(REST_API + "?t=" + Date.now());
                let val = await res.json();
                if(val) eksekusiRedirect(val);
            } catch(e) {}
        }

        function triggerBurstMode() {
            if (!isWaiting || hasRedirected) return;
            cekCepat();
            
            let count = 0;
            let interval = setInterval(() => {
                if(hasRedirected || count > 20) {
                    clearInterval(interval);
                } else {
                    cekCepat();
                    count++;
                }
            }, 150);
        }

        // --- TEKNIK 3: ACTIVE POLLING ---
        function mulaiPollingAktif() {
            setInterval(() => {
                if(isWaiting && !hasRedirected) cekCepat();
            }, 1000);
        }

        // --- DETEKSI AKTIVITAS LAYAR ---
        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === 'visible') triggerBurstMode();
        });
        window.addEventListener("focus", triggerBurstMode);
        window.addEventListener("touchstart", triggerBurstMode);

    </script>
</body>
</html>
